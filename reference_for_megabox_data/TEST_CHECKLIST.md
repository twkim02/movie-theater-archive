# 🧪 메가박스 통합 테스트 체크리스트

이 문서는 1단계와 2단계 작업을 테스트할 때 확인해야 하는 항목들을 정리합니다.

---

## 📱 테스트 화면에서 확인할 항목

### 접근 방법
1. 앱 실행
2. 탐색 탭의 우측 상단 버그 아이콘 클릭 (또는 TestScreen으로 직접 이동)
3. "메가박스" 탭 선택

---

## ✅ 1. CSV 파서 테스트

### 1.1. 메가박스 영화 목록
- **확인 항목**: 
  - ✅ 목록이 비어있지 않아야 함
  - ✅ 개수가 표시되어야 함 (예: "74개")
- **예상 결과**: 
  - 메가박스 영화가 74개 정도 표시되어야 함
  - `assets/megabox/movie.csv` 파일의 데이터와 일치해야 함

### 1.2. 메가박스 영화관 목록
- **확인 항목**:
  - ✅ 목록이 비어있지 않아야 함
  - ✅ 개수가 표시되어야 함 (예: "121개")
- **예상 결과**:
  - 영화관이 121개 정도 표시되어야 함
  - `assets/megabox/theater.csv` 파일의 데이터와 일치해야 함

### 1.3. 영화관 검색 (대전중앙로)
- **확인 항목**:
  - ✅ "대전중앙로" 영화관을 찾을 수 있어야 함
  - ✅ 영화관 이름이 표시되어야 함
- **예상 결과**:
  - "대전중앙로" 영화관 이름이 표시되어야 함
  - brchNo가 "3011"이어야 함

---

## ✅ 2. 영화 제목 매칭 테스트

### 2.1. 정확한 매칭 (만약에 우리)
- **확인 항목**:
  - ✅ "만약에 우리" 영화를 찾을 수 있어야 함
  - ✅ 영화명이 정확히 표시되어야 함
- **예상 결과**:
  - "만약에 우리" 영화가 찾아지고, movieNo가 "25096900"이어야 함

### 2.2. 부분 매칭 (아바타)
- **확인 항목**:
  - ✅ "아바타"로 검색했을 때 "아바타: 불과 재"를 찾을 수 있어야 함
- **예상 결과**:
  - "아바타: 불과 재" 영화가 찾아지고, movieNo가 "25094900"이어야 함

### 2.3. 상영 여부 확인
- **확인 항목**:
  - ✅ "만약에 우리"가 메가박스에서 상영 중인지 확인
- **예상 결과**:
  - "상영 중" 또는 "상영 안 함"이 표시되어야 함
  - `movie.csv`에 있으면 "상영 중"이어야 함 (메가박스는 now/upcoming 분리가 없음)

---

## ✅ 3. 메가박스 API 클라이언트 테스트

### 3.1. 상영 시간표 가져오기 버튼
- **확인 항목**:
  - ✅ 버튼을 클릭하면 로딩 화면이 표시되어야 함
  - ✅ 성공 시 상영 시간표가 표시되어야 함
  - ✅ 실패 시 적절한 에러 메시지가 표시되어야 함

### 3.2. 실제 API 호출 테스트
**주의**: 이 테스트는 실제 네트워크 연결이 필요하며, 메가박스 서버 상태에 따라 결과가 달라질 수 있습니다.

**테스트 시나리오**:
1. 버튼 클릭: "상영 시간표 가져오기 (대전중앙로, 만약에 우리)"
2. 로딩 화면 확인
3. 결과 확인:
   - **성공 시**: 
     - 상영 시간표 다이얼로그가 표시됨
     - **오늘 날짜**와 **내일 날짜** 두 섹션으로 구분되어 표시됨
     - 각 섹션에 날짜가 표시됨 (예: "📅 2026-01-13 (오늘)", "📅 2026-01-14 (내일)")
     - 각 상영 시간표에 시작 시간, 종료 시간, 상영관, 잔여 좌석 수가 표시됨
     - 예: "17:30 ~ 19:34 | 1관 | 잔여: 150/200석"
     - 성공 메시지에 총 개수와 오늘/내일 개수가 표시됨 (예: "총 5개의 상영 시간표를 가져왔습니다! (오늘: 3개, 내일: 2개)")
   - **실패 시**:
     - 에러 메시지가 표시됨
     - 가능한 원인:
       - 네트워크 연결 오류
       - 해당 날짜에 상영하지 않음
       - API 서버 오류
       - 영화관 또는 영화 정보가 변경됨

**예상 결과**:
- 오늘과 내일 날짜에 "만약에 우리"가 대전중앙로에서 상영 중이라면 각각의 상영 시간표가 표시되어야 함
- 오늘만 상영하거나 내일만 상영하는 경우에도 해당 날짜의 상영 시간표가 표시되어야 함
- 둘 다 상영하지 않거나 네트워크 오류가 있으면 적절한 메시지가 표시되어야 함

**메가박스 API 특징**:
- 날짜 형식: YYYYMMDD (롯데시네마는 YYYY-MM-DD)
- Payload 형식: JSON (롯데시네마는 form-urlencoded)
- Response 구조: movieFormList 배열

---

## 🔍 추가 확인 사항

### CSV 파일 로딩 확인
- **확인 방법**: 앱을 처음 실행할 때 CSV 파일이 제대로 로드되는지 확인
- **확인 항목**:
  - ✅ 앱이 크래시하지 않아야 함
  - ✅ 테스트 화면에서 데이터가 표시되어야 함

### 캐싱 동작 확인
- **확인 방법**: 같은 데이터를 여러 번 요청했을 때
- **확인 항목**:
  - ✅ 두 번째 요청부터는 빠르게 로드되어야 함 (캐싱 효과)
  - ✅ 데이터가 일관되게 표시되어야 함

### 에러 처리 확인
- **확인 방법**: 네트워크를 끊고 API 호출 테스트
- **확인 항목**:
  - ✅ 앱이 크래시하지 않아야 함
  - ✅ 적절한 에러 메시지가 표시되어야 함
  - ✅ 빈 리스트를 반환해야 함

---

## 📝 테스트 결과 기록

### 성공 기준
- ✅ 모든 CSV 파서 테스트 통과
- ✅ 모든 영화 제목 매칭 테스트 통과
- ✅ API 클라이언트가 에러 없이 동작 (실제 API 호출 성공 여부는 서버 상태에 따라 다를 수 있음)

### 실패 시 확인 사항
1. **CSV 파일이 로드되지 않는 경우**:
   - `pubspec.yaml`에 `assets/megabox/` 경로가 추가되었는지 확인
   - `flutter pub get` 실행
   - 앱 재시작

2. **영화 제목 매칭이 실패하는 경우**:
   - CSV 파일의 영화명과 TMDb 제목이 일치하는지 확인
   - 매칭 로직이 제대로 작동하는지 디버그 로그 확인

3. **API 호출이 실패하는 경우**:
   - 네트워크 연결 확인
   - 메가박스 서버 상태 확인
   - 영화관 번호(brchNo)와 영화 번호(movieNo)가 올바른지 확인
   - 날짜 형식이 YYYYMMDD인지 확인
   - 에러 메시지 확인

---

## ✅ 3단계: 영화관 정보와 상영 시간표 통합 테스트

### 3.1. TheaterScheduleService 확장 테스트

#### 3.1.1. 메가박스 상영 시간표 가져오기
- **확인 항목**:
  - ✅ `getMegaboxSchedule()` 메서드가 정상적으로 작동하는지 확인
  - ✅ 메가박스 영화관 감지가 올바르게 작동하는지 확인
  - ✅ 메가박스가 아닌 영화관은 빈 리스트를 반환하는지 확인
  - ✅ 존재하지 않는 영화/영화관으로 요청 시 빈 리스트를 반환하는지 확인
  - ✅ 캐시가 제대로 작동하는지 확인
- **테스트 화면 확인 방법**:
  1. TestScreen → "메가박스" 탭
  2. "4. 상영 시간표 서비스 테스트 (3단계)" 섹션 확인
  3. "메가박스 상영 시간표 가져오기" 결과 확인
  4. "상영 시간표 상세 보기" 버튼 클릭하여 오늘/내일 상영 시간표 확인

#### 3.1.2. 통합 메서드 (getSchedule) 테스트
- **확인 항목**:
  - ✅ 롯데시네마 영화관은 롯데시네마 메서드를 호출하는지 확인
  - ✅ 메가박스 영화관은 메가박스 메서드를 호출하는지 확인
  - ✅ CGV 같은 다른 영화관은 빈 리스트를 반환하는지 확인
  - ✅ 통합 메서드가 롯데시네마와 메가박스를 올바르게 구분하는지 확인
  - ✅ 통합 메서드 캐시가 제대로 작동하는지 확인
- **테스트 화면 확인 방법**:
  1. TestScreen → "메가박스" 탭
  2. "4. 상영 시간표 서비스 테스트 (3단계)" 섹션 확인
  3. "통합 메서드 (getSchedule)" 결과 확인
  4. "CGV 영화관 (메가박스 아님)" 결과 확인 (빈 리스트)
  5. "롯데시네마 영화관 (통합 메서드)" 결과 확인

### 3.2. 단위 테스트 실행 결과

**테스트 파일**: `test/services/theater_schedule_service_test.dart`

**실행 명령어**:
```bash
flutter test test/services/theater_schedule_service_test.dart
```

**테스트 결과** (2026-01-14 기준):
- ✅ **16개 테스트 모두 통과**
- ✅ 롯데시네마 영화관 감지 테스트 통과
- ✅ 메가박스 영화관 감지 테스트 통과
- ✅ 통합 메서드 (getSchedule) 테스트 통과
- ✅ 캐시 기능 테스트 통과
- ✅ 에러 처리 테스트 통과

**주요 확인 사항**:
- 메가박스 영화관 감지: "메가박스", "메가" 포함 시 정상 감지
- 롯데시네마 영화관 감지: "롯데시네마", "롯데" 포함 시 정상 감지
- 통합 메서드: 영화관 이름에 따라 자동으로 적절한 메서드 호출
- 캐시: 같은 파라미터로 두 번 요청 시 캐시에서 가져옴
- 에러 처리: 존재하지 않는 영화/영화관으로 요청 시 빈 리스트 반환 (크래시 없음)

### 3.3. dummy_theaters.dart 통합 테스트

**확인 항목**:
- ✅ `fetchNearbyTheatersReal()`에서 메가박스 영화관도 처리하는지 확인
- ✅ `TheaterScheduleService.getSchedule()` 통합 메서드 사용 확인
- ✅ 롯데시네마와 메가박스 모두 자동 감지하여 상영 시간표 가져오기 확인

**실제 사용 시나리오**:
1. 탐색 탭 → 상영 중인 영화 선택 → "영화관 보기" 버튼 클릭
2. 주변 영화관 목록에서:
   - "롯데시네마" 또는 "롯데" 포함 → 롯데시네마 상영 시간표 표시
   - "메가박스" 또는 "메가" 포함 → 메가박스 상영 시간표 표시
   - 그 외 (CGV 등) → "시간표는 예매/시간표에서 확인할 수 있어요." 메시지 표시

### 3.4. TheaterCard 위젯 테스트

**확인 항목**:
- ✅ 메가박스 영화관에도 "실시간 상영 시간표" 라벨 표시
- ✅ 메가박스 상영 시간표도 파란색 Chip으로 표시
- ✅ `_isSupportedTheater()` 메서드가 롯데시네마와 메가박스 모두 감지하는지 확인

**실제 사용 시나리오**:
1. 탐색 탭 → 상영 중인 영화 선택 → "영화관 보기" 버튼 클릭
2. 메가박스 영화관 카드에서:
   - "실시간 상영 시간표" 라벨 표시 확인
   - 상영 시간표가 파란색 Chip으로 표시되는지 확인
   - 각 Chip에 "시작시간~종료시간 · 상영관" 형식으로 표시되는지 확인

---

## 🎯 다음 단계로 넘어가기 전 확인

다음 항목들이 모두 확인되면 4단계로 진행할 수 있습니다:

- [x] CSV 파서가 모든 데이터를 올바르게 로드함
- [x] 영화 제목 매칭이 정확하게 작동함
- [x] API 클라이언트가 에러 없이 동작함 (실제 API 호출 성공 여부는 서버 상태에 따라 다를 수 있음)
- [x] 에러 처리가 적절하게 작동함
- [x] 테스트 화면에서 모든 기능이 정상적으로 표시됨
- [x] 추가 테스트 케이스 (다양한 매칭, 에러 처리) 확인 완료
- [x] **3단계: 영화관 정보와 상영 시간표 통합 테스트 완료**
  - [x] TheaterScheduleService 확장 (메가박스 지원)
  - [x] 통합 메서드 (getSchedule) 구현 및 테스트
  - [x] dummy_theaters.dart 수정 및 통합
  - [x] TheaterCard 위젯 수정
  - [x] 단위 테스트 모두 통과 (16개)
- [x] **4단계: TMDb 초기화 시 메가박스 상영 여부 확인 완료**
  - [x] MegaboxMovieChecker 서비스 생성
  - [x] MovieInitializationService 수정 (롯데시네마 + 메가박스)
  - [x] 단위 테스트 모두 통과 (4개)
  - [x] TestScreen에 테스트 섹션 추가

---

## ✅ 4단계: TMDb 초기화 시 메가박스 상영 여부 확인 테스트

### 4.1. MegaboxMovieChecker 서비스 테스트

**테스트 파일**: `test/services/megabox_movie_checker_test.dart`

**실행 명령어**:
```bash
flutter test test/services/megabox_movie_checker_test.dart
```

**테스트 결과** (2026-01-14 기준):
- ✅ **4개 테스트 모두 통과**
- ✅ 메가박스에서 상영 중인 영화 확인 테스트 통과
- ✅ 메가박스에서 상영하지 않는 영화 확인 테스트 통과
- ✅ 다양한 영화 제목으로 테스트 통과
- ✅ 에러 발생 시 false 반환 테스트 통과

**주요 확인 사항**:
- 메가박스 CSV에 있는 영화는 `true` 반환
- 메가박스 CSV에 없는 영화는 `false` 반환
- 에러 발생 시 조용히 `false` 반환 (크래시 없음)

### 4.2. MovieInitializationService 통합 테스트

**확인 항목**:
- ✅ 현재 상영 중인 영화 (`_saveNowPlayingMovies`)에서 롯데시네마와 메가박스 모두 확인
- ✅ 인기 영화 (`_savePopularMovies`)에서 롯데시네마와 메가박스 모두 확인
- ✅ 둘 중 하나라도 상영 중이면 `isRecent = true` 설정
- ✅ 에러 발생 시에도 계속 진행 (TMDb 기준으로 처리)

**테스트 화면 확인 방법**:
1. TestScreen → "메가박스" 탭
2. "5. 메가박스 영화 확인 서비스 테스트 (4단계)" 섹션 확인
3. 개별 확인:
   - "메가박스 상영 여부 확인 (만약에 우리)" → "상영 중"
   - "메가박스 상영 여부 확인 (프로젝트 Y)" → "상영 중"
   - "메가박스 상영 여부 확인 (존재하지 않는 영화)" → "상영 안 함"
4. 통합 확인:
   - "롯데시네마 상영 여부" 확인
   - "메가박스 상영 여부" 확인
   - "통합 확인 (둘 중 하나라도 상영 중)" → 둘 중 하나라도 true이면 "상영 중 (isRecent = true)"

**실제 동작 시나리오**:
1. TMDb API에서 영화 정보 가져오기
2. 각 영화에 대해:
   - 롯데시네마 CSV 확인 (`LotteCinemaMovieChecker.isPlayingInLotteCinema()`)
   - 메가박스 CSV 확인 (`MegaboxMovieChecker.isPlayingInMegabox()`)
   - 둘 중 하나라도 `true`이면 `isRecent = true` 설정
3. DB에 저장

**로직 예시**:
```dart
final isPlayingInLotte = await LotteCinemaMovieChecker.isPlayingInLotteCinema(movieTitle);
final isPlayingInMegabox = await MegaboxMovieChecker.isPlayingInMegabox(movieTitle);
if (isPlayingInLotte || isPlayingInMegabox) {
  isRecent = true;
}
```

### 4.3. 통합 테스트 실행 결과

**테스트 파일**: `test/services/movie_initialization_service_integration_test.dart`

**실행 명령어**:
```bash
flutter test test/services/movie_initialization_service_integration_test.dart
```

**테스트 결과** (2026-01-14 기준):
- ✅ **6개 테스트 모두 통과**
- ✅ 롯데시네마와 메가박스 모두 확인하는지 테스트 통과
- ✅ 롯데시네마에서만 상영 중인 경우 테스트 통과
- ✅ 메가박스에서만 상영 중인 경우 테스트 통과
- ✅ 둘 다 상영 중인 경우 테스트 통과
- ✅ 둘 다 상영하지 않는 경우 테스트 통과
- ✅ 에러 발생 시에도 계속 진행하는지 확인 테스트 통과

**주요 확인 사항**:
- **롯데시네마에서만 상영 중**: `isRecent = true` 설정 ✅
- **메가박스에서만 상영 중**: `isRecent = true` 설정 ✅
- **둘 다 상영 중**: `isRecent = true` 설정 ✅
- **둘 다 상영하지 않음**: `isRecent = false` 유지 ✅
- **에러 발생 시**: 조용히 `false` 반환, 크래시 없음 ✅

**전체 테스트 요약**:
- `megabox_movie_checker_test.dart`: 4개 테스트 통과
- `movie_initialization_service_integration_test.dart`: 6개 테스트 통과
- **총 10개 테스트 모두 통과** ✅

---

## 📌 롯데시네마와의 차이점

메가박스 테스트 시 롯데시네마와 다른 점을 주의해야 합니다:

| 항목 | 롯데시네마 | 메가박스 |
|------|-----------|---------|
| 영화 CSV | movie_now.csv, movie_upcoming.csv (분리) | movie.csv (단일) |
| 영화관 검색 예시 | "대전센트럴" | "대전중앙로" |
| 날짜 형식 | YYYY-MM-DD | YYYYMMDD |
| Payload 형식 | form-urlencoded | JSON |
| Response 구조 | PlaySeqs.Items | movieFormList |

---

## ✅ 4. 추가 테스트 케이스

### 4.1. 다양한 영화 제목 매칭
- **확인 항목**:
  - ✅ 다른 영화 제목도 정확하게 매칭되는지 확인
  - ✅ 존재하지 않는 영화는 null을 반환하는지 확인
- **테스트 영화**:
  - "프로젝트 Y" (CSV에 있는 영화)
  - "존재하지 않는 영화 12345" (CSV에 없는 영화)
- **예상 결과**:
  - "프로젝트 Y"는 찾아져야 함
  - "존재하지 않는 영화 12345"는 null이어야 함

### 4.2. 다양한 영화관 검색
- **확인 항목**:
  - ✅ 다양한 영화관 이름으로 검색이 잘 되는지 확인
  - ✅ "메가박스" 접두사가 있어도 검색이 되는지 확인
  - ✅ 존재하지 않는 영화관은 null을 반환하는지 확인
- **테스트 영화관**:
  - "강남" (단순 이름)
  - "메가박스 대전" (접두사 포함)
  - "존재하지 않는 영화관" (CSV에 없는 영화관)
- **예상 결과**:
  - "강남"과 "메가박스 대전"은 찾아져야 함
  - "존재하지 않는 영화관"은 null이어야 함

### 4.3. 에러 처리 테스트
- **확인 항목**:
  - ✅ 존재하지 않는 영화관/영화로 API 호출 시 에러가 발생하지 않는지 확인
  - ✅ 빈 리스트를 반환하는지 확인
  - ✅ 앱이 크래시하지 않는지 확인
- **테스트 시나리오**:
  1. "에러 처리 테스트" 버튼 클릭
  2. 존재하지 않는 영화관(brchNo: '9999')과 영화(movieNo: '99999999')로 API 호출
  3. 결과 확인:
     - 빈 리스트가 반환되어야 함
     - 에러 메시지 없이 정상 처리되어야 함
     - 성공 메시지에 "빈 리스트 반환 (0개)" 표시

---

## ✅ 5. 실제 앱 통합 테스트 (선택사항)

### 5.1. 탐색 탭에서 영화관 보기
**주의**: 이 테스트는 3단계 작업이 완료된 후에 가능합니다.

**테스트 시나리오**:
1. 탐색 탭에서 상영 중인 영화 선택 (예: "만약에 우리")
2. "영화관 보기" 버튼 클릭
3. 주변 영화관 목록 확인:
   - **메가박스 영화관**: 
     - 상영 시간표가 칩 형태로 표시되어야 함
     - 예: "17:30~19:34 · 1관"
     - 여러 개의 상영 시간표가 있으면 모두 표시되어야 함
     - "실시간 상영 시간표" 라벨이 표시되어야 함
     - 파란색 배경의 Chip으로 표시되어야 함
   - **롯데시네마 영화관**: 
     - 롯데시네마도 동일하게 상영 시간표가 표시되어야 함
   - **다른 영화관 (CGV 등)**:
     - "시간표는 예매/시간표에서 확인할 수 있어요." 메시지 표시
     - 하이퍼링크 버튼만 표시

**예상 결과**:
- 메가박스와 롯데시네마 영화관에서만 실제 상영 시간표가 표시됨
- 다른 영화관은 기존처럼 하이퍼링크만 제공됨
- 네트워크 오류나 상영 시간표가 없어도 앱이 크래시하지 않아야 함

---

## 🔍 고급 테스트 (선택사항)

### 동시 요청 테스트
- **목적**: 여러 영화관/영화에 대한 동시 요청이 정상적으로 처리되는지 확인
- **방법**: 테스트 화면에서 여러 버튼을 빠르게 연속 클릭
- **확인 항목**:
  - ✅ 모든 요청이 정상적으로 처리되어야 함
  - ✅ 캐싱이 제대로 작동해야 함
  - ✅ 메모리 누수가 발생하지 않아야 함

### 날짜 경계 테스트
- **목적**: 자정을 넘어가는 경우 등 날짜 경계에서 정상 동작하는지 확인
- **방법**: 자정 직전/직후에 테스트
- **확인 항목**:
  - ✅ 날짜 형식이 올바르게 변환되어야 함 (YYYYMMDD)
  - ✅ 오늘/내일 구분이 정확해야 함

### 메모리 사용량 확인
- **목적**: CSV 캐싱과 API 응답 캐싱이 메모리를 과도하게 사용하지 않는지 확인
- **방법**: 앱을 장시간 실행하고 메모리 사용량 모니터링
- **확인 항목**:
  - ✅ 메모리 사용량이 일정하게 유지되어야 함
  - ✅ 캐시 정리 기능이 작동해야 함

---

**문서 작성일**: 2026년 1월  
**테스트 대상**: 1단계 (CSV 파싱) + 2단계 (API 클라이언트)
